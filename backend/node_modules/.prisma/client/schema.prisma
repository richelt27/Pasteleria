generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum EstadoUsuario {
  ACTIVO
  SUSPENDIDO
  INACTIVO

  @@map("estado_usuario")
}

enum UnidadMedida {
  KG
  LITRO
  UNIDAD
  GRAMO
  MILILITRO

  @@map("unidad_medida")
}

enum TipoMovimiento {
  COMPRA
  USO_PRODUCCION
  MERMA
  AJUSTE
  VENTA_DIRECTA

  @@map("tipo_movimiento")
}

enum EstadoOrden {
  PENDIENTE
  EN_PRODUCCION
  HORNEADO
  DECORADO
  TERMINADO

  @@map("estado_orden")
}

enum TipoEntrega {
  DELIVERY
  RECOJO_TIENDA

  @@map("tipo_entrega")
}

enum EstadoPedido {
  PENDIENTE_PAGO
  CONFIRMADO
  EN_PREPARACION
  EN_RUTA
  ENTREGADO
  CANCELADO

  @@map("estado_pedido")
}

enum MetodoPago {
  TARJETA_CREDITO
  TARJETA_DEBITO
  YAPE_PLIN
  EFECTIVO
  TRANSFERENCIA

  @@map("metodo_pago")
}

// Modelos

model Rol {
  id_rol      Int       @id @default(autoincrement())
  nombre      String    @unique @db.VarChar(50)
  descripcion String?   @db.Text
  usuarios    Usuario[]

  @@map("roles")
}

model Usuario {
  id_usuario        Int           @id @default(autoincrement())
  id_rol            Int
  nombre_completo   String        @db.VarChar(100)
  email             String        @unique @db.VarChar(100)
  password_hash     String        @db.VarChar(255)
  telefono          String?       @db.VarChar(20)
  direccion_default String?       @db.Text
  estado            EstadoUsuario @default(ACTIVO)
  fecha_registro    DateTime?     @default(now()) @db.Timestamptz

  rol                 Rol                 @relation(fields: [id_rol], references: [id_rol])
  movimientos_almacen MovimientoAlmacen[]
  ordenes_produccion  OrdenProduccion[]
  pedidos             Pedido[]
  entregas_asignadas  Entrega[]

  @@map("usuarios")
}

model Proveedor {
  id_proveedor    Int      @id @default(autoincrement())
  razon_social    String   @db.VarChar(150)
  ruc             String?  @unique @db.VarChar(20)
  contacto_nombre String?  @db.VarChar(100)
  telefono        String?  @db.VarChar(20)
  email_contacto  String?  @db.VarChar(100)
  insumos         Insumo[]

  @@map("proveedores")
}

model Insumo {
  id_insumo              Int          @id @default(autoincrement())
  nombre                 String       @db.VarChar(100)
  descripcion            String?      @db.Text
  unidad                 UnidadMedida
  stock_actual           Decimal?     @default(0) @db.Decimal(12, 3)
  stock_minimo           Decimal?     @default(5) @db.Decimal(12, 3)
  costo_promedio         Decimal?     @db.Decimal(10, 2)
  id_proveedor_preferido Int?

  proveedor           Proveedor?          @relation(fields: [id_proveedor_preferido], references: [id_proveedor])
  movimientos_almacen MovimientoAlmacen[]
  recetas             Receta[]

  @@map("insumos")
}

model MovimientoAlmacen {
  id_movimiento          BigInt         @id @default(autoincrement())
  id_insumo              Int
  tipo                   TipoMovimiento
  cantidad               Decimal        @db.Decimal(12, 3)
  costo_unitario         Decimal?       @db.Decimal(10, 2)
  fecha_movimiento       DateTime?      @default(now()) @db.Timestamptz
  id_usuario_responsable Int?
  observacion            String?        @db.Text

  insumo  Insumo   @relation(fields: [id_insumo], references: [id_insumo])
  usuario Usuario? @relation(fields: [id_usuario_responsable], references: [id_usuario])

  @@map("movimientos_almacen")
}

model Categoria {
  id_categoria Int        @id @default(autoincrement())
  nombre       String     @db.VarChar(50)
  imagen_url   String?    @db.Text
  activo       Boolean?   @default(true)
  productos    Producto[]

  @@map("categorias")
}

model Producto {
  id_producto       Int      @id @default(autoincrement())
  nombre            String   @db.VarChar(150)
  descripcion       String?  @db.Text
  precio_base       Decimal  @db.Decimal(10, 2)
  id_categoria      Int?
  imagen_url        String?  @db.Text
  es_personalizable Boolean? @default(false)
  stock_vitrina     Int?     @default(0)
  activo            Boolean? @default(true)

  categoria          Categoria?        @relation(fields: [id_categoria], references: [id_categoria])
  recetas            Receta[]
  ordenes_produccion OrdenProduccion[]
  detalles_pedido    DetallePedido[]

  @@map("productos")
}

model Receta {
  id_receta          Int           @id @default(autoincrement())
  id_producto        Int
  id_insumo          Int
  cantidad_requerida Decimal       @db.Decimal(12, 3)
  unidad_uso         UnidadMedida?

  producto Producto @relation(fields: [id_producto], references: [id_producto])
  insumo   Insumo   @relation(fields: [id_insumo], references: [id_insumo])

  @@map("recetas")
}

model OrdenProduccion {
  id_produccion         Int          @id @default(autoincrement())
  id_producto           Int?
  cantidad_a_producir   Int
  fecha_inicio          DateTime?    @default(now()) @db.Timestamptz
  fecha_fin_estimada    DateTime?    @db.Timestamptz
  id_pastelero_asignado Int?
  estado                EstadoOrden? @default(PENDIENTE)
  lote_interno          String?      @db.VarChar(50)
  fecha_vencimiento     DateTime?    @db.Date

  producto  Producto? @relation(fields: [id_producto], references: [id_producto])
  pastelero Usuario?  @relation(fields: [id_pastelero_asignado], references: [id_usuario])

  @@map("ordenes_produccion")
}

model Pedido {
  id_pedido                Int           @id @default(autoincrement())
  id_usuario               Int?
  fecha_pedido             DateTime?     @default(now()) @db.Timestamptz
  fecha_entrega_programada DateTime      @db.Timestamptz
  tipo_entrega             TipoEntrega
  direccion_entrega        String?       @db.Text
  referencia_direccion     String?       @db.Text
  total_productos          Decimal?      @db.Decimal(10, 2)
  costo_envio              Decimal?      @default(0) @db.Decimal(10, 2)
  total_pagar              Decimal?      @db.Decimal(10, 2)
  estado                   EstadoPedido? @default(PENDIENTE_PAGO)
  observaciones_generales  String?       @db.Text

  usuario       Usuario?        @relation(fields: [id_usuario], references: [id_usuario])
  detalles      DetallePedido[]
  pagos         Pago[]
  entrega_datos Entrega?

  @@map("pedidos")
}

model DetallePedido {
  id_detalle      Int     @id @default(autoincrement())
  id_pedido       Int
  id_producto     Int
  cantidad        Int
  precio_unitario Decimal @db.Decimal(10, 2)
  subtotal        Decimal @db.Decimal(10, 2)
  personalizacion Json?   @db.JsonB

  pedido   Pedido   @relation(fields: [id_pedido], references: [id_pedido])
  producto Producto @relation(fields: [id_producto], references: [id_producto])

  @@map("detalle_pedido")
}

model Pago {
  id_pago                     Int        @id @default(autoincrement())
  id_pedido                   Int
  metodo                      MetodoPago
  monto                       Decimal    @db.Decimal(10, 2)
  fecha_pago                  DateTime?  @default(now()) @db.Timestamptz
  codigo_transaccion_pasarela String?    @db.VarChar(100)
  comprobante_url             String?    @db.Text
  estado                      String?    @default("COMPLETADO") @db.VarChar(20)

  pedido Pedido @relation(fields: [id_pedido], references: [id_pedido])

  @@map("pagos")
}

model Entrega {
  id_entrega         Int       @id @default(autoincrement())
  id_pedido          Int       @unique
  id_repartidor      Int?
  fecha_salida       DateTime? @db.Timestamptz
  fecha_entrega_real DateTime? @db.Timestamptz
  evidencia_foto_url String?   @db.Text
  estado_delivery    String?   @default("EN_PREPARACION") @db.VarChar(50)

  pedido     Pedido   @relation(fields: [id_pedido], references: [id_pedido])
  repartidor Usuario? @relation(fields: [id_repartidor], references: [id_usuario])

  @@map("entregas")
}
